name: Deploy curboinomix_1.0

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: "Image tag to deploy"
        default: "curboinomix_1.0"
        required: true
  release:
    types: [published]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }} # e.g. owner/repo
  SERVICE_DIR: /opt/curboinomix
  COMPOSE_FILE: docker-compose.yml

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || github.event.release.prerelease == false
    steps:
      - name: Resolve image tag
        id: tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "TAG=${{ github.event.inputs.image_tag }}" >> $GITHUB_OUTPUT
          else
            echo "TAG=curboinomix_1.0" >> $GITHUB_OUTPUT
          fi

      - name: SSH deploy
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: $ {{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script_stop: true
          script: |
            set -e
            mkdir -p ${{ env.SERVICE_DIR }}
            cd ${{ env.SERVICE_DIR }}

            echo "Logging into registry"
            echo "${{ secrets.GHCR_TOKEN }}" | docker login ${{ env.REGISTRY }} -u ${{ secrets.GHCR_USERNAME }} --password-stdin

            IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.TAG }}"
            echo "Using image: $IMAGE"

            # Optional: write .env for compose substitutions
            echo "IMAGE=$IMAGE" > .env

            # Pull and restart via compose
            if [ -f "${{ env.COMPOSE_FILE }}" ]; then
              docker compose pull
              docker compose up -d --remove-orphans
            else
              # Fallback: run single container
              docker pull "$IMAGE"
              docker rm -f curboinomix || true
              docker run -d --name curboinomix --restart=always -p 80:80 "$IMAGE"
            fi

            docker image prune -f
